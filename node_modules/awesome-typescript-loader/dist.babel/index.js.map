{"version":3,"sources":["../dist/index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator.throw(value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments)).next());\n    });\n};\nrequire('source-map-support').install();\nrequire('babel-polyfill');\nconst promisify = require('es6-promisify');\nconst _ = require('lodash');\nconst path = require('path');\nconst deps_1 = require('./deps');\nconst cache_1 = require('./cache');\nconst helpers = require('./helpers');\nconst instance_1 = require('./instance');\nlet loaderUtils = require('loader-utils');\nlet cachePromise = promisify(cache_1.cache);\nfunction loader(text) {\n    return __awaiter(this, void 0, void 0, function* () {\n        try {\n            yield compiler.call(undefined, this, text);\n        }\n        catch (e) {\n            console.error(e, e.stack);\n            throw e;\n        }\n    });\n}\nfunction compiler(webpack, text) {\n    return __awaiter(this, void 0, void 0, function* () {\n        if (webpack.cacheable) {\n            webpack.cacheable();\n        }\n        let options = loaderUtils.parseQuery(webpack.query);\n        let instanceName = options.instanceName || 'default';\n        let instance = instance_1.ensureInstance(webpack, options, instanceName);\n        let state = instance.tsState;\n        let callback = webpack.async();\n        let fileName = state.normalizePath(webpack.resourcePath);\n        let resolver = deps_1.createResolver(webpack._compiler.options.externals, state.options.exclude || [], webpack.resolve);\n        let depsInjector = {\n            add: (depFileName) => webpack.addDependency(depFileName),\n            clear: webpack.clearDependencies.bind(webpack)\n        };\n        let applyDeps = _.once(() => {\n            depsInjector.clear();\n            depsInjector.add(fileName);\n            state.fileAnalyzer.dependencies.applyCompiledFiles(fileName, depsInjector);\n            if (state.options.reEmitDependentFiles) {\n                state.fileAnalyzer.dependencies.applyChain(fileName, depsInjector);\n            }\n        });\n        if (instance.options.externals && !instance.externalsInvoked) {\n            if (instance.externalsInvocation) {\n                yield instance.externalsInvocation;\n            }\n            else {\n                let promises = instance.options.externals.map((external) => __awaiter(this, void 0, void 0, function* () {\n                    yield state.fileAnalyzer.checkDependencies(resolver, external);\n                }));\n                instance.externalsInvocation = Promise.all(promises).then(() => {\n                    instance.externalsInvoked = true;\n                });\n                yield instance.externalsInvocation;\n            }\n        }\n        instance.compiledFiles[fileName] = true;\n        let doUpdate = false;\n        if (instance.options.useWebpackText) {\n            if (state.updateFile(fileName, text, true)) {\n                doUpdate = true;\n            }\n        }\n        try {\n            let wasChanged = yield state.fileAnalyzer.checkDependencies(resolver, fileName);\n            if (wasChanged || doUpdate) {\n                state.updateProgram();\n            }\n            let compiledModule;\n            if (instance.options.usePrecompiledFiles) {\n                compiledModule = cache_1.findCompiledModule(fileName);\n            }\n            let transformation = null;\n            if (compiledModule) {\n                state.fileAnalyzer.dependencies.addCompiledModule(fileName, compiledModule.fileName);\n                transformation = {\n                    text: compiledModule.text,\n                    map: compiledModule.map\n                        ? JSON.parse(compiledModule.map)\n                        : null\n                };\n            }\n            else {\n                function transform() {\n                    let resultText;\n                    let resultSourceMap = null;\n                    let output = state.emit(fileName);\n                    let result = helpers.findResultFor(output, fileName);\n                    if (result.text === undefined) {\n                        throw new Error('No output found for ' + fileName);\n                    }\n                    resultText = result.text;\n                    let sourceFileName = fileName.replace(process.cwd() + '/', '');\n                    if (result.sourceMap) {\n                        resultSourceMap = JSON.parse(result.sourceMap);\n                        resultSourceMap.sources = [sourceFileName];\n                        resultSourceMap.file = sourceFileName;\n                        resultSourceMap.sourcesContent = [text];\n                        resultText = resultText.replace(/^\\/\\/# sourceMappingURL=[^\\r\\n]*/gm, '');\n                    }\n                    if (instance.options.useBabel) {\n                        let defaultOptions = {\n                            inputSourceMap: resultSourceMap,\n                            sourceRoot: process.cwd(),\n                            filename: fileName,\n                            sourceMap: true\n                        };\n                        let babelResult = instance.babelImpl.transform(resultText, defaultOptions);\n                        resultText = babelResult.code;\n                        resultSourceMap = babelResult.map;\n                    }\n                    return {\n                        text: resultText,\n                        map: resultSourceMap\n                    };\n                }\n                if (instance.options.useCache) {\n                    transformation = yield cachePromise({\n                        source: text,\n                        identifier: instance.cacheIdentifier,\n                        directory: instance.options.cacheDirectory,\n                        options: webpack.query,\n                        transform: transform\n                    });\n                }\n                else {\n                    transformation = transform();\n                }\n            }\n            let resultText = transformation.text;\n            let resultSourceMap = transformation.map;\n            if (resultSourceMap) {\n                let sourcePath = path.relative(instance.options.sourceRoot, loaderUtils.getRemainingRequest(webpack));\n                resultSourceMap.sources = [sourcePath];\n                resultSourceMap.file = fileName;\n                resultSourceMap.sourcesContent = [text];\n            }\n            try {\n                callback(null, resultText, resultSourceMap);\n            }\n            catch (e) {\n                console.error('Error in bail mode:', e, e.stack.join\n                    ? e.stack.join('\\n')\n                    : e.stack);\n                process.exit(1);\n            }\n        }\n        catch (err) {\n            console.error(err.toString(), err.stack.toString());\n            callback(err, helpers.codegenErrorReport([err]));\n        }\n        finally {\n            applyDeps();\n        }\n    });\n}\nclass ForkCheckerPlugin {\n    apply(compiler) {\n        compiler.plugin(\"watch-run\", function (params, callback) {\n            compiler._tsFork = true;\n            callback();\n        });\n    }\n}\nloader.ForkCheckerPlugin = ForkCheckerPlugin;\nmodule.exports = loader;\n//# sourceMappingURL=index.js.map"]}